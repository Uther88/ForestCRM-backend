(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[7],{"+rhg":function(t,e,s){},S1bz:function(t,e,s){"use strict";s.r(e);var i=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"row justify-center full-height bg-grey-5 scroll"},[s("div",{staticClass:"bg-white row",style:t.getStyle},[s("q-toolbar",{staticClass:"shadow-2 no-padding",attrs:{color:"indigo"}},[s("q-toolbar-title",{staticStyle:{"font-size":"12px"}},[t._v("\n        Участники: \n        "),t._l(t.chat.members,function(e){return s("span",[s("img",{staticClass:"avatar",staticStyle:{width:"20px",height:"20px"},attrs:{src:e.avatar||"statics/anon.png"}}),t._v("\n        "+t._s(e.full_name)+"\n      ")])})],2)],1),s("div",{ref:"messagesList",staticClass:"scroll col full-height bg-white",staticStyle:{border:"1px solid lightgrey"},attrs:{id:"messagesList"}},[s("transition-group",{attrs:{"enter-active-class":"animated bounceInDown"}},t._l(t.chat_messages,function(e){return s("q-chat-message",{key:e.id,staticClass:"q-px-sm chat",attrs:{sent:e.sender.id==t.$user.id,name:e.sender.full_name,text:t.handleMessageText(e.text,e.files),avatar:e.sender.avatar||"statics/anon.png",stamp:new Date(e.created_date).toLocaleString(),size:"8"}},[e.sender.id==t.$user.id&&e.is_new?s("q-icon",{attrs:{name:"new_releases",title:"Не прочитанное",color:"green"}}):t._e()],1)})),0==t.chat_messages.length?s("div",{staticClass:"text-center"},[s("p",[t._v("\n            Сообщений нет\n          ")])]):t._e(),s("q-scroll-observable",{on:{scroll:t.getMoreMessages}}),s("q-resize-observable",{attrs:{debounce:700},on:{resize:t.scrollTo}})],1),s("form",{ref:"chatForm",staticClass:"full-width",attrs:{enctype:"multipart/form-data",id:"chatForm",name:"chatForm"}},[s("div",{staticClass:"row items-center bg-indigo shadow-2",staticStyle:{"border-top":"1px solid lightgrey"}},[s("div",{staticClass:"col-12 q-pa-sm"},[s("q-input",{staticClass:"q-px-sm bg-white",staticStyle:{border:"1px solid lightgrey","border-radius":"3px"},attrs:{"hide-underline":"",type:"textarea",clearable:"","max-length":"200",placeholder:"Введите сообщение"},model:{value:t.form.text,callback:function(e){t.$set(t.form,"text",e)},expression:"form.text"}})],1)]),s("div",{staticClass:"row bg-indigo justify-around"},[s("div",{staticClass:"col-xs-8 col-sm-5 col-md-4 q-pa-sm"},[s("q-uploader",{ref:"fileField",staticClass:"generic-margin",attrs:{url:"",multiple:"",dark:"",before:[{icon:"attachment"}],"float-label":"Прикрепить файлы","hide-upload-button":!0,"hide-underline":""},on:{add:t.addFile,"remove:cancel":t.removeFile}})],1),s("div",{staticClass:"col-xs-4 col-sm-2 col-md-3 text-center q-pa-sm"},[s("q-btn",{attrs:{type:"button",icon:"send",glossy:"",color:"positive"},on:{click:t.sendMessage}})],1)])])],1)])},a=[];i._withStripped=!0;s("dRSK"),s("rGqo"),s("KKXr");var n=s("H+D6"),r={name:"MessageView",props:["id"],data:function(){return{more_messages:null,chat_messages:[],chat:{members:[]},form:{recipient:[],title:"",text:"",files:[]}}},computed:{getStyle:function(){return this.$q.platform.is.mobile?"height: calc(100vh - 250px); min-width: 100vw;":"height: calc(100vh - 270px); min-width: 60vw;"}},methods:{addNewMessage:function(t){t&&(this.chat_messages.push(t),this.scrollTo())},sendMessage:function(){var t=this;if(this.form.text.length){this.form.title=this.form.text.slice(0,25),this.form.title+=this.form.text.length>25?"...":"";var e=new FormData;e.append("title",this.form.title),e.append("text",this.form.text),e.append("recipient",this.chat.members.filter(function(e){return e.id!=t.$user.id}).map(function(t){return t.id})),e.append("sender",this.$user.id);for(var s=0;s<this.form.files.length;s++){var i=this.form.files[s];e.append("files",i)}this.$axios.post("/api/v1/messages/",e).then(function(e){t.resetForm(),t.addNewMessage(e.data)}).catch(function(e){t.$q.notify({message:e.message})})}},addFile:function(t){for(var e=0;e<t.length;e++)this.form.files.push(t[e])},removeFile:function(t){this.form.files=this.form.files.files.filter(function(e){return e!==t})},resetForm:function(){this.form.title=this.form.text="",this.form.recipient=this.form.files=[],this.$refs["fileField"].reset(),this.$refs["chatForm"].reset()},getMoreMessages:Object(n["a"])(function(t){this.more_messages&&"up"==t.direction&&this.getMessages()},500),scrollTo:Object(n["a"])(function(t){"down"==t?this.$refs["messagesList"].scroll({top:0}):this.$refs["messagesList"].scroll({top:this.$refs["messagesList"].scrollHeight})},300),handleMessageText:function(t,e){var s=[];if(t&&s.push(t),e.length)for(var i=0;i<e.length;i++){var a=document.createElement("a");a.href=e[i].file,a.text=a.href.split("/").reverse()[0],s.push(a.outerHTML)}return s},getChat:function(){var t=this;this.$axios.get("/api/v1/chats/"+this.id+"/").then(function(e){t.chat=e.data}).catch(function(t){})},checkOutcomming:function(){var t=this,e={limit:10,chats:this.id,sender:this.$user.id};this.$axios.get("/api/v1/messages/",{params:e}).then(function(e){e.data.messages.forEach(function(e){e.is_new||(t.chat_messages.find(function(t){return t.id==e.id}).is_new=!1)})})},getMessages:function(){var t=this,e={limit:10,chats:this.id};this.$axios.get(this.more_messages||"/api/v1/messages/",{params:e}).then(function(e){e.data.messages.forEach(function(e){return t.chat_messages.unshift(e)}),t.more_messages=e.data.meta.next}).catch(function(t){})},getNewMessages:function(){var t=this;this.checkOutcomming();var e={chats:this.id,is_new:!0,recipient__id:this.$user.id};this.$axios.get("/api/v1/messages/",{params:e}).then(function(e){e.data.messages.forEach(function(e){return t.addNewMessage(e)})}).catch(function(t){})}},created:function(){this.newMessagesCheker=setInterval(this.getNewMessages,1e4)},mounted:function(){this.getChat(),this.getMessages()},destroyed:function(){clearInterval(this.newMessagesCheker)}},o=r,c=(s("jiFB"),s("gvy1"),s("KHd+")),l=Object(c["a"])(o,i,a,!1,null,null,null);e["default"]=l.exports},gvy1:function(t,e,s){"use strict";var i=s("+rhg"),a=s.n(i);a.a},jiFB:function(t,e,s){"use strict";var i=s("qC50"),a=s.n(i);a.a},qC50:function(t,e,s){}}]);