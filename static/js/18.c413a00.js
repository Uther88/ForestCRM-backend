(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[18],{HqH3:function(t,a,e){},UDtT:function(t,a,e){"use strict";e.r(a);var n=function(){var t=this,a=t.$createElement,e=t._self._c||a;return e("div",{staticClass:"full-height bg-grey-4 items-start",attrs:{id:"svodnaya-vedomost"}},[e("div",{staticClass:"row bg-indigo glossy q-pa-sm full-width flex-center"},[e("q-field",{staticClass:"col-md col-sm-12 q-pa-xs",attrs:{label:"Участок","label-width":"3"}},[e("q-select",{staticClass:"bg-white round-borders",staticStyle:{padding:"5px"},attrs:{options:t.options.stations.map(function(t){return{label:t.name,value:t.id}}),separator:"","hide-underline":"",disable:!this.$user.is_staff||!t.is_editable},model:{value:t.form.station,callback:function(a){t.$set(t.form,"station",a)},expression:"form.station"}})],1),e("q-field",{staticClass:"col-md-2 col-sm-12 q-pa-xs",attrs:{label:"Отдел","label-width":"3"}},[e("q-select",{staticClass:"bg-white round-borders",staticStyle:{padding:"5px"},attrs:{options:t.$store.state.main.departaments,separator:"","hide-underline":"",disable:!t.is_editable},model:{value:t.form.departament,callback:function(a){t.$set(t.form,"departament",a)},expression:"form.departament"}})],1),e("q-field",{staticClass:"col-md-2 col-sm-12 q-pa-xs",attrs:{label:"Дата","label-width":"3"}},[e("q-datetime",{staticClass:"bg-white round-borders",staticStyle:{padding:"5px"},attrs:{type:"date",value:t.form.date,"format-model":"date",format:"MM.YYYY",align:"center","hide-underline":"","default-view":"month",modal:"",disable:!t.is_editable},on:{input:function(a){t.form.date=new Date(a).toDateString()}}})],1),e("q-field",{staticClass:"col-md col-sm-12 q-pa-xs",attrs:{label:"Вид работ","label-width":"3"}},[e("q-select",{staticClass:"bg-white round-borders",staticStyle:{padding:"5px"},attrs:{options:t.options.events.map(function(t){return{label:t.full_name,value:t.id}}),"hide-underline":"",separator:"",clearable:"",filter:""},model:{value:t.form.event,callback:function(a){t.$set(t.form,"event",a)},expression:"form.event"}})],1),e("div",{staticClass:"col-md-1 col-sm-12 flex flex-center q-pa-xs"},[e("q-btn",{attrs:{label:"Поиск",color:"positive",glossy:"",disabled:!(this.form.date&&this.form.station&&this.form.departament&&!t.form.calcs.length)},on:{click:t.getWaybills}})],1)],1),e("div",{staticClass:"row col-12 q-pa-xs"},[e("div",{staticClass:"col-12 bg-white shadow-1"},[e("q-table",{attrs:{data:t.options.waybills,columns:t.waybill_columns,"hide-bottom":"",dense:"","table-style":"min-height: 25vh;","table-class":"text-center calcs-table",pagination:t.pagination,separator:"cell",grid:""},scopedSlots:t._u([{key:"top",fn:function(a){return[e("span",[t._v("Путевые листы")])]}},{key:"body-cell-options",fn:function(a){return e("q-td",{attrs:{props:a}},[e("q-btn",{attrs:{icon:"add",dense:"",color:"positive"},nativeOn:{click:function(e){t.calcWaybill(a.row)}}})],1)}}])})],1),e("div",{staticClass:"col-12 q-mt-sm shadow-1 bg-white"},[e("q-table",{attrs:{data:t.form.calcs,columns:t.columns,dense:"","table-class":"calcs-table bg-white","hide-bottom":"",separator:"cell","table-style":"min-height: 25vh;",pagination:t.pagination,grid:""},scopedSlots:t._u([{key:"top",fn:function(a){return[e("span",[t._v("Расчеты")])]}},{key:"body-cell-options",fn:function(a){return e("q-td",{},[e("q-btn",{attrs:{icon:"edit",flat:"",dense:"",color:"primary"},nativeOn:{click:function(e){t.editCalc(a.row)}}}),e("q-btn",{attrs:{icon:"delete",flat:"",dense:"",color:"negative"},nativeOn:{click:function(e){t.removeCalc(a.row)}}})],1)}},{key:"bottom-row",fn:function(a){return[e("tr",{staticClass:"table-bottom text-center",staticStyle:{bottom:"0"}},[e("td",[t._v("ИТОГО:")]),e("td",[t._v(" ")]),e("td",[t._v(" ")]),e("td",[t._v(" ")]),e("td",[t._v(t._s(t.form.hours))]),e("td",[t._v(" ")]),e("td",[t._v(" ")]),e("td",[t._v(" ")]),e("td",[t._v(" ")]),e("td",[t._v(t._s(t.form.amount))]),e("td",[t._v(t._s(t.form.recast_half))]),e("td",[t._v(t._s(t.form.recast_double))]),e("td",[t._v(t._s(t.form.holydays))]),e("td",[t._v(t._s(t.form.classines))]),e("td",[t._v(t._s(t.form.bonus))]),e("td",[t._v(t._s(t.form.coefficient))]),e("td",[t._v(t._s(t.form.amount_total))])])]}}])})],1)]),e("div",{staticClass:"row col-12 q-pa-md flex-center justify-center group"},[e("q-btn",{attrs:{label:"Отчистить",color:"negative"},on:{click:t.resetAll}}),e("q-btn",{attrs:{label:"Сохранить",color:"positive",glossy:"",disabled:!t.form.calcs.length>0},nativeOn:{click:function(a){return t.saveVedomost(a)}}})],1),e("q-modal",{ref:"add-calc",attrs:{id:"calc-modal","content-css":"max-height: 100%; max-width: 500px;"},on:{hide:t.resetCalcForm}},[e("div",[e("q-toolbar",{attrs:{glossy:""}},[e("q-toolbar-title",{staticClass:"text-center"},[t._v("Добавить расчет")]),e("q-btn",{directives:[{name:"close-overlay",rawName:"v-close-overlay"}],attrs:{flat:"",icon:"close"}})],1),this.calc_form.__instance?e("div",{staticClass:"q-pa-xs"},[e("table",{staticClass:"fit text-center calc_table",attrs:{cellspacing:"0",cellpadding:"5"}},[e("tr",[e("td",[t._v("Водитель:")]),e("td",[t._v(t._s(t.calc_form.__instance.driver.full_name))])]),e("tr",[e("td",[t._v("№:")]),e("td",[t._v(t._s(t.calc_form.__instance.number))])]),e("tr",[e("td",[t._v("Дата:")]),e("td",[t._v(t._s(new Date(t.calc_form.__instance.date).toLocaleDateString()))])]),e("tr",[e("td",[t._v("Часы:")]),e("td",[t._v(t._s(t.calc_form.__instance.total_hours))])]),e("tr",[e("td",[t._v("Ставка:")]),e("td",[t._v(t._s(t.calc_form.data.rate))])])]),e("div",{staticClass:"row justify-between group q-py-sm text-center"},[e("q-field",{staticClass:"col",attrs:{label:"Классность",orientation:"vertical"}},[e("input",{directives:[{name:"model",rawName:"v-model",value:t.calc_form.data.classines,expression:"calc_form.data.classines"}],staticClass:"text-center",staticStyle:{width:"100px"},attrs:{min:0,type:"number",align:"center"},domProps:{value:t.calc_form.data.classines},on:{input:[function(a){a.target.composing||t.$set(t.calc_form.data,"classines",a.target.value)},t.calcSummary]}})]),e("q-field",{staticClass:"col",attrs:{label:"Премия",orientation:"vertical"}},[e("input",{directives:[{name:"model",rawName:"v-model",value:t.calc_form.data.bonus,expression:"calc_form.data.bonus"}],staticClass:"text-center",staticStyle:{width:"100px"},attrs:{min:0,type:"number",align:"center"},domProps:{value:t.calc_form.data.bonus},on:{input:[function(a){a.target.composing||t.$set(t.calc_form.data,"bonus",a.target.value)},t.calcSummary]}})]),e("q-field",{staticClass:"col",attrs:{label:"Коэффициент",orientation:"vertical"}},[e("input",{directives:[{name:"model",rawName:"v-model",value:t.calc_form.data.coefficient,expression:"calc_form.data.coefficient"}],staticClass:"text-center",staticStyle:{width:"100px"},attrs:{min:0,type:"number",align:"center"},domProps:{value:t.calc_form.data.coefficient},on:{input:[function(a){a.target.composing||t.$set(t.calc_form.data,"coefficient",a.target.value)},t.calcSummary]}})])],1),e("table",{staticClass:"fit text-center calc_table",attrs:{cellspacing:"0",cellpadding:"5"}},[e("tr",[e("td",{attrs:{width:"75%"}},[t._v("Основная зарплата")]),e("td",[t._v(t._s(t.calc_form.data.amount))])]),e("tr",[e("td",[t._v("Переработка в 1,5 раз")]),e("td",[t._v(t._s(t.calc_form.data.recast_half))])]),e("tr",[e("td",[t._v("Переработка в 2 раза")]),e("td",[t._v(t._s(t.calc_form.data.recast_double))])]),e("tr",[e("td",[t._v("Праздничные")]),e("td",[t._v(t._s(t.calc_form.data.amount_holydays))])]),e("tr",[e("td",[t._v("Классность")]),e("td",[t._v(t._s(t.calc_form.data.amount_classines))])]),e("tr",[e("td",[t._v("Премия")]),e("td",[t._v(t._s(t.calc_form.data.amount_bonus))])]),e("tr",[e("td",[t._v("Коэффициент")]),e("td",[t._v(t._s(t.calc_form.data.amount_coefficient))])]),e("tr",[e("td",[t._v("Итого")]),e("td",[t._v(t._s(t.calc_form.data.amount_total))])])])]):t._e(),e("q-toolbar",{staticClass:"justify-center group"},[e("q-btn",{attrs:{icon:"save",label:"Сохранить",glossy:"",color:"positive"},nativeOn:{click:function(a){return t.saveCalc(a)}}}),e("q-btn",{directives:[{name:"close-overlay",rawName:"v-close-overlay"}],attrs:{icon:"close",label:"Отмена",glossy:"",color:"negative"}})],1)],1)])],1)},s=[];n._withStripped=!0;e("yt8O"),e("RW0V"),e("rGqo"),e("Vd3H"),e("KKXr");var o={name:"SvodnayaVedomostPrintPage",data:function(){var t=this;return{pagination:{rowsPerPage:50},addNewEntryDialog:!1,form:{date:null,station:this.$user.station,departament:null,event:null,calcs:[],hours:0,amount:0,classines:0,recast_half:0,recast_double:0,holydays:0,bonus:0,coefficient:0,amount_total:0},calc_form:{__instance:null,data:{waybill:null,rate:null,classines:null,coefficient:null,bonus:null,amount:null,amount_classines:null,recast_half:null,recast_double:null,amount_holydays:null,amount_bonus:null,amount_coefficient:null,amount_total:null}},options:{stations:[],events:[],waybills:[]},columns:[{name:"options",label:"Опции",field:"__index",align:"center"},{name:"driver",label:"ФИО",field:function(t){return t.__instance.driver.full_name},align:"center"},{name:"date",label:"Дата",field:function(t){return new Date(t.__instance.date).toLocaleDateString()},align:"center"},{name:"number",label:"Номер",field:function(t){return t.__instance.number},align:"center"},{name:"hours",label:"Часы.",field:function(t){return t.__instance.total_hours},align:"center"},{name:"rate",label:"Ставка",field:function(a){return t.$store.state.main.rates[a.__instance.driver.rank]},align:"center"},{name:"classines",label:"Классность",field:function(t){return t.data.classines},align:"center"},{name:"coefficient",label:"Коэффициент",field:function(t){return t.data.coefficient},align:"center"},{name:"bonus",label:"Премия",field:function(t){return t.data.bonus},align:"center"},{name:"amount",label:"Оплата: основная",field:function(t){return t.data.amount},align:"center"},{name:"recast_half",label:"Оплата: переработка в 1,5 раз",field:function(t){return t.data.recast_half},align:"center"},{name:"recast_double",label:"Оплата: переработка в 2 раза",field:function(t){return t.data.recast_double},align:"center"},{name:"amount_holydays",label:"Оплата: праздничные",field:function(t){return t.data.amount_holydays},align:"center"},{name:"amount_classines",label:"Оплата: Классность",field:function(t){return t.data.amount_classines},align:"center"},{name:"amount_bonus",label:"Оплата: премия",field:function(t){return t.data.amount_bonus},align:"center"},{name:"amount_coefficient",label:"Оплата: коэффициент",field:function(t){return t.data.amount_coefficient},align:"center"},{name:"amount_total",label:"Оплата: итого",field:function(t){return t.data.amount_total},align:"center"}],waybill_columns:[{name:"options",label:"Опции",field:"id",align:"center"},{name:"driver",label:"Водитель",field:function(t){return t.driver.full_name},align:"center"},{name:"number",label:"Номер",field:function(t){return t.number},align:"center"},{name:"hours",label:"Часы",field:function(t){return t.total_hours},align:"center"},{name:"date",label:"Дата",field:function(t){return new Date(t.date).toLocaleDateString()},align:"center"}]}},computed:{is_editable:function(){return!(this.form.calcs.length>0||this.options.waybills.length>0)}},methods:{getStations:function(){var t=this;this.$axios.get("/api/v1/stations/").then(function(a){t.options.stations=a.data.stations}).catch(function(t){})},getEvents:function(){var t=this;this.$axios.get("/api/v1/outfit_events/").then(function(a){t.options.events=a.data.outfit_events}).catch(function(t){})},getWaybills:function(){var t=this;if(this.form.date&&this.form.station&&this.form.departament){var a=new Date(this.form.date),e={station:this.form.station,date__year:a.getFullYear(),date__month:a.getMonth()+1,departament:this.form.departament,is_completed:!0,conducted:!1};this.$axios.get("/api/v1/waybill/",{params:e}).then(function(a){t.options.waybills=a.data.waybills}).catch(function(t){})}},calcWaybill:function(t){this.calc_form.__instance=t,this.calc_form.data.waybill=t.id,this.calc_form.data.rate=this.$store.state.main.rates[t.driver.rank],this.calc_form.data.amount=(parseFloat(t.total_hours)*parseFloat(this.calc_form.data.rate)).toFixed(2),this.recastCalc(t.date,t.total_hours),this.calcSummary(),this.$refs["add-calc"].show()},calcSummary:function(){parseFloat(this.calc_form.data.rate);var t,a,e,n,s=parseFloat(this.calc_form.data.classines)||0,o=parseFloat(this.calc_form.data.bonus)||0,l=parseFloat(this.calc_form.data.coefficient)||0,i=parseFloat(this.calc_form.data.recast_half)||0,c=parseFloat(this.calc_form.data.recast_double)||0,r=parseFloat(this.calc_form.data.amount),d=parseFloat(this.calc_form.data.amount_holydays)||0;e=s?r*s/100:0,a=o?r*o/100:0,t=l?r*l:0,n=r+i+c+d+a+e+t,d&&(this.calc_form.data.amount_holydays=d.toFixed(2)),this.calc_form.data.amount_bonus=a.toFixed(2),this.calc_form.data.amount_classines=e.toFixed(2),this.calc_form.data.amount_coefficient=t.toFixed(2),this.calc_form.data.amount_total=n.toFixed(2)},recastCalc:function(t,a){var e=this,n={params:{pre:1},transformRequest:[function(t,a){return delete a.common["X-CSRFToken"],t}]},s=new Date(t).toLocaleDateString().split(".").reverse();this.$axios.get("https://isdayoff.ru/"+s[0]+s[1]+s[2],n).then(function(t){1==t.data&&(e.calc_form.data.amount_holydays=e.calc_form.data.amount)}),parseFloat(a)>8&&(this.calc_form.data.recast_half=this.calc_form.data.rate,parseFloat(a)>10&&(this.calc_form.data.recast_double=(2*parseFloat(this.calc_form.data.rate)).toFixed(2)))},saveCalc:function(){var t=JSON.parse(JSON.stringify(this.calc_form));this.form.calcs.some(function(a){return a.__instance.id==t.__instance.id})?this.form.calcs[t.__index]=t:(this.form.calcs.push(t),this.options.waybills.splice(t.__instance.__index,1)),this.form.calcs.sort(),this.$refs["add-calc"].hide()},editCalc:function(t){this.calc_form.__instance=t.__instance,this.calc_form=JSON.parse(JSON.stringify(t)),this.$refs["add-calc"].show()},removeCalc:function(t){this.options.waybills.push(t.__instance),this.form.calcs.splice(t.__index,1),this.options.waybills.sort(function(t,a){return t.id>a.id})},resetCalcForm:function(){var t=this;Object.keys(this.calc_form.data).forEach(function(a){return t.calc_form.data[a]=null}),this.calc_form.__instance=null},resetAll:function(){this.options.waybills=[],this.form.calcs=[],this.form.departament=null,this.form.date=null,this.form.event=null},saveVedomost:function(){var t=this;if(this.form.calcs.length>0){var a=JSON.stringify(this.form);this.$axios.post("/api/v1/svodnie_vedomosti/",a).then(function(a){t.done(a.data.id)}).catch(function(a){t.$q.notify({message:a.message,color:"negative"})})}},done:function(t){var a=this;this.$q.dialog({title:"Готово",message:"Открыть печатную форму?",ok:!0,cancel:!0}).then(function(){a.$router.push({name:"PrintSvodnayaVedomost",params:{id:t}})}).catch(function(){a.$router.push({name:"SvodnayaVedomost"})})}},mounted:function(){this.getStations(),this.getEvents()},watch:{"form.calcs":function(){var t=0,a=0,e=0,n=0,s=0,o=0,l=0,i=0,c=0;this.form.calcs.forEach(function(r){t+=parseFloat(r.__instance.total_hours),a+=parseFloat(r.data.amount),e+=parseFloat(r.data.amount_classines)||0,n+=parseFloat(r.data.recast_half)||0,s+=parseFloat(r.data.recast_double)||0,o+=parseFloat(r.data.amount_holydays)||0,l+=parseFloat(r.data.amount_bonus)||0,i+=parseFloat(r.data.amount_coefficient)||0,c+=parseFloat(r.data.amount_total)}),this.form.hours=t,this.form.amount=a,this.form.classines=e,this.form.recast_half=n,this.form.recast_double=s,this.form.holydays=o,this.form.bonus=l,this.form.coefficient=i,this.form.amount_total=c}}},l=o,i=(e("bQGO"),e("KHd+")),c=Object(i["a"])(l,n,s,!1,null,null,null);a["default"]=c.exports},bQGO:function(t,a,e){"use strict";var n=e("HqH3"),s=e.n(n);s.a}}]);